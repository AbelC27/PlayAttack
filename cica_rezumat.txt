# PlayAtac - Gaming Subscription Platform

## ğŸ“‹ Table of Contents

1. [Architecture Overview](#architecture-overview)
2. [Technology Stack](#technology-stack)
3. [System Architecture & Data Flow](#system-architecture--data-flow)
4. [Frontend-Backend Connection](#frontend-backend-connection)
5. [Supabase Integration](#supabase-integration)
6. [Backend Functionality (Detailed)](#backend-functionality-detailed)
7. [Database Models](#database-models)
8. [API Endpoints Reference](#api-endpoints-reference)
9. [Authentication & Authorization](#authentication--authorization)
10. [Session Management](#session-management)
11. [Payment Processing](#payment-processing)
12. [Analytics & Reporting](#analytics--reporting)
13. [Setup & Configuration](#setup--configuration)
14. [Docker Architecture](#docker-architecture)

---

## Architecture Overview

PlayAtac is a full-stack gaming subscription platform built with a **React frontend**, **Django REST Framework backend**, and **Supabase** as the authentication provider and primary database. The application follows a modern microservices-inspired architecture with containerized deployment via Docker.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CLIENT BROWSER                               â”‚
â”‚                    (React SPA on Port 3000)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â”‚ HTTP/HTTPS Requests
                             â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                                     â”‚
           â”‚                                     â”‚
           â–¼                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   SUPABASE AUTH      â”‚              â”‚  DJANGO BACKEND      â”‚
â”‚   (Authentication)   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  (REST API)          â”‚
â”‚   - User Login       â”‚   Validates  â”‚  Port 8000           â”‚
â”‚   - JWT Tokens       â”‚   JWT Token  â”‚                      â”‚
â”‚   - Session Mgmt     â”‚              â”‚  - Business Logic    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚  - Data Processing   â”‚
           â”‚                          â”‚  - Analytics         â”‚
           â”‚                          â”‚  - Payments          â”‚
           â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                                     â”‚
           â”‚                                     â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ Direct PostgreSQL Connection
                         â”‚
                         â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   SUPABASE DATABASE  â”‚
              â”‚   (PostgreSQL)       â”‚
              â”‚   - Users            â”‚
              â”‚   - Plans            â”‚
              â”‚   - Subscriptions    â”‚
              â”‚   - Payments         â”‚
              â”‚   - Sessions         â”‚
              â”‚   - Analytics Data   â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Technology Stack

### Frontend
- **React** 18.x - Modern UI library
- **React Router** 6.x - Client-side routing
- **Supabase JS Client** - Authentication and real-time subscriptions
- **Fetch API** - HTTP requests to Django backend
- **CSS-in-JS** - Component-level styling

### Backend
- **Django** 5.2.7 - Python web framework
- **Django REST Framework** 3.x - API framework
- **PostgreSQL** (via Supabase) - Relational database
- **Supabase Python Client** - Database and auth integration
- **Stripe Python SDK** - Payment processing
- **Matplotlib** - Chart generation for analytics
- **ReportLab** - PDF report generation

### Infrastructure
- **Docker** - Containerization
- **Docker Compose** - Multi-container orchestration
- **Supabase** - Backend-as-a-Service (BaaS)
  - PostgreSQL Database
  - Authentication Service
  - Real-time subscriptions
  - Row Level Security (RLS)

---

## System Architecture & Data Flow

### 1. **User Registration Flow**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    1. Submit Form      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  React   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  Supabase    â”‚
â”‚ Signup   â”‚                        â”‚  Auth API    â”‚
â”‚ Componentâ”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    2. Returns User    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚            & JWT Token              â”‚
      â”‚                                     â”‚
      â”‚ 3. Create User Profile              â”‚
      â–¼                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   useAuth    â”‚    4. Insert       â”‚   Supabase   â”‚
â”‚    Hook      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚   Database   â”‚
â”‚              â”‚    app_user table  â”‚  (PostgreSQL)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Steps:**
1. User fills signup form in React
2. Frontend calls `supabase.auth.signUp(email, password)`
3. Supabase creates auth user and returns JWT token
4. Frontend calls `createUserProfile()` to insert record in `app_user` table
5. User is now registered in both Supabase Auth and PostgreSQL database

---

### 2. **Login Flow**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    1. Login Request    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  React   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  Supabase    â”‚
â”‚  Login   â”‚                        â”‚  Auth API    â”‚
â”‚  Page    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    2. JWT Token        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                                     
      â”‚ 3. Track Session                   
      â–¼                                     
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    4. POST          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   useAuth    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚    Django     â”‚
â”‚    Hook      â”‚  /session-tracking/ â”‚   Backend    â”‚
â”‚              â”‚                     â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                            â”‚
                                            â”‚ 5. Create UserSession
                                            â–¼
                                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                     â”‚   Supabase   â”‚
                                     â”‚   Database   â”‚
                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Steps:**
1. User enters credentials
2. `supabase.auth.signInWithPassword()` validates credentials
3. Supabase returns JWT token and user object
4. Frontend calls Django `/api/session-tracking/` to create session record
5. Django creates `UserSession` record with login_time
6. User is authenticated and session is tracked

---

### 3. **API Request Flow (Authenticated)**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  React   â”‚    1. Get JWT Token    â”‚ SessionStorageâ”‚
â”‚Component â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  (Browser)   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ 2. HTTP Request + Auth Header
     â”‚    Authorization: Bearer <JWT>
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Django    â”‚    3. Validate JWT â”‚   Supabase   â”‚
â”‚   Backend    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚   Auth API   â”‚
â”‚              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    4. User Info    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 5. Process Request
       â”‚    (Business Logic)
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Supabase   â”‚    6. Query/Update Data
â”‚   Database   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 7. Return Response
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    React     â”‚    8. Update UI
â”‚   Component  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Steps:**
1. React component needs data (e.g., user subscriptions)
2. Gets JWT token from Supabase session
3. Sends HTTP request to Django with `Authorization: Bearer <JWT>` header
4. Django validates JWT with Supabase (via `SupabaseJWTAuthentication`)
5. Django processes request (queries database, applies business logic)
6. Django returns JSON response
7. React updates UI with data

---

## Frontend-Backend Connection

### Environment Configuration

**Frontend (.env)**
```bash
REACT_APP_SUPABASE_URL=https://your-project.supabase.co
REACT_APP_SUPABASE_ANON_KEY=your-anon-key
REACT_APP_DJANGO_URL=http://localhost:8000
REACT_APP_STRIPE_PUBLISHABLE_KEY=pk_test_...
```

**Backend (.env)**
```bash
SUPABASE_DB_URL=postgresql://postgres:[password]@db.xxx.supabase.co:5432/postgres
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_KEY=your-service-role-key
STRIPE_SECRET_KEY=sk_test_...
STRIPE_PUBLISHABLE_KEY=pk_test_...
```

### Connection Points

#### 1. **Direct Supabase Connection (Frontend)**

```javascript
// frontend/exemplu/src/supabaseClient.js
import { createClient } from "@supabase/supabase-js";

export const supabase = createClient(
  process.env.REACT_APP_SUPABASE_URL,
  process.env.REACT_APP_SUPABASE_ANON_KEY,
  {
    auth: {
      persistSession: false  // Session managed via sessionStorage
    }
  }
);
```

**Used For:**
- User authentication (login/signup/logout)
- Getting JWT tokens for API requests
- Real-time data subscriptions (if needed)
- Client-side user profile queries

---

#### 2. **Django REST API Connection (Frontend)**

```javascript
// frontend/exemplu/src/api/djangoApi.js
const BASE_URL = process.env.REACT_APP_DJANGO_URL || "http://localhost:8000";

export async function apiCall(endpoint, options = {}) {
  // Get JWT token from Supabase session
  const { data: { session } } = await supabase.auth.getSession();
  const token = session?.access_token;

  const response = await fetch(`${BASE_URL}${endpoint}`, {
    ...options,
    headers: {
      "Authorization": `Bearer ${token}`,
      "Content-Type": "application/json",
      ...options.headers
    }
  });

  if (!response.ok) {
    throw new Error(`API error: ${response.status}`);
  }

  return response.json();
}
```

**Used For:**
- All business logic operations
- Complex data queries with joins
- Analytics and reporting
- Payment processing
- Admin operations
- Session tracking

---

#### 3. **Django to Supabase Connection (Backend)**

```python
# backend/config/settings.py
DATABASES = {
    "default": dj_database_url.config(default=SUPABASE_DB_URL)
}

SUPABASE_URL = os.getenv("SUPABASE_URL")
SUPABASE_KEY = os.getenv("SUPABASE_KEY")
```

```python
# backend/app/views.py
from supabase import create_client

supabase = create_client(settings.SUPABASE_URL, settings.SUPABASE_KEY)
```

**Used For:**
- Direct PostgreSQL queries via Django ORM
- Supabase Auth API calls (when needed)
- Reading auth user data
- Managing database tables

---

## Supabase Integration

### Database Connection

Django connects directly to Supabase's PostgreSQL database using the connection string. This allows Django to use its ORM (Object-Relational Mapping) for database operations.

**Connection String Format:**
```
postgresql://postgres:[YOUR-PASSWORD]@db.[PROJECT-REF].supabase.co:5432/postgres
```

**Django Models â†’ PostgreSQL Tables:**
- `User` model â†’ `app_user` table
- `Plan` model â†’ `app_plan` table
- `Subscription` model â†’ `app_subscription` table
- `Payment` model â†’ `app_payment` table
- `Cost` model â†’ `app_cost` table
- `UserSession` model â†’ `app_usersession` table

---

### Authentication Flow (Detailed)

#### Supabase Auth vs Django Auth

**Supabase Auth (Primary):**
- Manages user credentials
- Issues JWT tokens
- Handles password resets
- Manages sessions
- Provides authentication UI (if needed)

**Django (Secondary):**
- Validates JWT tokens
- Stores user profile data
- Manages business permissions
- Links users to subscriptions/payments

#### JWT Token Structure

```json
{
  "aud": "authenticated",
  "exp": 1696204800,
  "sub": "550e8400-e29b-41d4-a716-446655440000",  // User ID
  "email": "user@example.com",
  "phone": "",
  "app_metadata": {
    "provider": "email",
    "providers": ["email"]
  },
  "user_metadata": {},
  "role": "authenticated"
}
```

#### Token Validation in Django

```python
# backend/app/authentication.py
from rest_framework.authentication import BaseAuthentication
from supabase import create_client
import jwt

class SupabaseJWTAuthentication(BaseAuthentication):
    def authenticate(self, request):
        auth_header = request.headers.get('Authorization', '')
        
        if not auth_header.startswith('Bearer '):
            return None
            
        token = auth_header.split(' ')[1]
        
        try:
            # Verify JWT with Supabase
            supabase = create_client(settings.SUPABASE_URL, settings.SUPABASE_KEY)
            user = supabase.auth.get_user(token)
            
            # Get or create Django user
            django_user = User.objects.get(id=user.id)
            
            return (django_user, None)
        except:
            return None
```

---

## Backend Functionality (Detailed)

### Core Views & Endpoints

#### 1. **User Management Views** (ğŸ”¥ Critical)

##### **SignupView** - `POST /api/signup/`
**Importance:** Critical - User onboarding entry point

**Purpose:** Creates user accounts in Django (mirrors Supabase auth users)

**Flow:**
1. Receives: `{ email, password, username }`
2. Validates email format and password strength
3. Creates Django `User` object with UUID from Supabase
4. Sets default role as "user"
5. Returns success/error response

**Code Location:** `backend/config/views.py`

```python
class SignupView(APIView):
    def post(self, request):
        serializer = UserSignupSerializer(data=request.data)
        if serializer.is_valid():
            serializer.save()  # Creates User with hashed password
            return Response({'message': 'User created successfully!'}, 
                          status=status.HTTP_201_CREATED)
        return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)
```

**Why It Matters:**
- Gateway for all new users
- Creates necessary database records
- Establishes user-subscription relationship foundation
- Validates business rules (email uniqueness, etc.)

---

##### **LoginView** - `POST /api/login/`
**Importance:** High - Primary authentication endpoint

**Purpose:** Authenticates users and creates Django session

**Flow:**
1. Receives: `{ username, password }`
2. Uses Django's `authenticate()` function
3. Creates session in Django
4. Returns success/error

**Note:** This is rarely used as Supabase handles primary authentication. Kept for Django admin access.

---

##### **Users (List/Update/Delete)** - `/api/users/`
**Importance:** Critical - Admin user management

**Purpose:** CRUD operations for user accounts (Admin only)

**Operations:**

**GET** - List all users with subscriptions
```python
def get(self, request):
    users = User.objects.all()
    # Returns: user data + active subscriptions + role
```

**PATCH** - Toggle user role (user â†”ï¸ admin)
```python
def patch(self, request):
    user_id = request.data.get('id')
    user = User.objects.get(id=user_id)
    # Toggles role between 'user' and 'admin'
```

**DELETE** - Remove user account
```python
def delete(self, request):
    user_id = request.data.get('id')
    # Prevents deletion of admin users
    # Cascades to subscriptions and payments
```

**Security:** All endpoints require authentication and admin role check

**Why It Matters:**
- Central admin panel functionality
- User lifecycle management
- Role-based access control
- Data integrity through cascade deletes

---

#### 2. **Plan Management** (ğŸ”¥ Critical)

##### **Plans View** - `/api/plans/`
**Importance:** Critical - Core business model

**Purpose:** Manages subscription plans (Free, Pro, Premium, etc.)

**Operations:**

**GET** - Retrieve all plans
```python
def get(self, request):
    plans = Plan.objects.all().order_by('price')
    # Returns: name, price, currency, features, id
```

**POST** - Create new plan (Admin only)
```python
def post(self, request):
    # Receives: name, price, currency, features
    plan = Plan.objects.create(...)
```

**PUT** - Update existing plan (Admin only)
```python
def put(self, request):
    plan_id = request.data.get('id')
    Plan.objects.filter(id=plan_id).update(...)
```

**DELETE** - Remove plan (Admin only)
```python
def delete(self, request):
    plan_id = request.data.get('id')
    Plan.objects.filter(id=plan_id).delete()
```

**Data Model:**
```python
class Plan(models.Model):
    name = models.CharField(max_length=50, unique=True)
    price = models.DecimalField(max_digits=10, decimal_places=2)
    currency = models.CharField(max_length=5, default="EUR")
    features = models.TextField(blank=True)  # Stored as comma-separated text
    created_at = models.DateTimeField(auto_now_add=True)
```

**Why It Matters:**
- Defines revenue model
- Controls feature access
- Foundation for subscriptions
- Dynamic pricing without code changes

---

#### 3. **Subscription Management** (ğŸ”¥ Critical)

##### **UserSubscription** - `GET /api/user-subscription/`
**Importance:** Critical - User access control

**Purpose:** Retrieves user's active subscription details

**Flow:**
1. Authenticates user via JWT
2. Queries user's subscriptions
3. Filters for active status
4. Returns plan details + expiry dates

```python
def get(self, request):
    user = request.user
    subscriptions = Subscription.objects.filter(
        user=user, 
        status='active'
    ).select_related('plan')
    
    return Response({
        'subscription': {
            'plan_name': sub.plan.name,
            'plan_price': sub.plan.price,
            'status': sub.status,
            'start_date': sub.start_date,
            'renewal_date': sub.renewal_date
        }
    })
```

**Why It Matters:**
- Determines user access level
- Controls feature availability
- Displays subscription status in UI
- Drives upgrade/downgrade logic

---

##### **UserSubscriptionManagement** - `/api/subscription-management/`
**Importance:** High - Subscription lifecycle

**Purpose:** Create, upgrade, and cancel subscriptions

**Operations:**

**POST** - Create new subscription
```python
def post(self, request):
    user = request.user
    plan_id = request.data.get('plan_id')
    
    # Cancel existing subscriptions
    Subscription.objects.filter(user=user).update(status='canceled')
    
    # Create new subscription
    subscription = Subscription.objects.create(
        user=user,
        plan_id=plan_id,
        status='active',
        start_date=timezone.now(),
        renewal_date=timezone.now() + timedelta(days=30)
    )
```

**PUT** - Upgrade/downgrade subscription
```python
def put(self, request):
    # Check business rules (can't downgrade from paid to free)
    # Update subscription plan
    # Calculate prorated charges (if applicable)
```

**DELETE** - Cancel subscription
```python
def delete(self, request):
    subscription_id = request.data.get('subscription_id')
    subscription = Subscription.objects.get(id=subscription_id)
    subscription.status = 'canceled'
    subscription.end_date = timezone.now()
    subscription.save()
```

**Business Rules:**
- âœ… Can upgrade from Free â†’ Pro â†’ Premium
- âŒ Cannot downgrade from Premium â†’ Pro (must cancel first)
- âœ… Cancellation is immediate (no partial refunds)
- âœ… One active subscription per user

**Why It Matters:**
- Core revenue operations
- Enforces business logic
- Prevents subscription abuse
- Tracks subscription history

---

#### 4. **Payment Processing** (ğŸ”¥ Critical)

##### **Stripe Configuration** - `/api/stripe-config/`
**Importance:** Critical - Payment gateway setup

**Purpose:** Provides Stripe publishable key to frontend

```python
class StripeConfig(APIView):
    permission_classes = [AllowAny]
    
    def get(self, request):
        return Response({
            'publicKey': settings.STRIPE_PUBLISHABLE_KEY
        })
```

---

##### **CreatePaymentIntent** - `/api/create-payment-intent/`
**Importance:** Critical - Payment initiation

**Purpose:** Creates Stripe payment intent for processing

**Flow:**
1. Receives plan_id from frontend
2. Looks up plan price
3. Creates Stripe PaymentIntent
4. Returns client_secret for frontend

```python
def post(self, request):
    import stripe
    stripe.api_key = settings.STRIPE_SECRET_KEY
    
    plan_id = request.data.get('plan_id')
    plan = Plan.objects.get(id=plan_id)
    
    # Create payment intent
    intent = stripe.PaymentIntent.create(
        amount=int(plan.price * 100),  # Cents
        currency=plan.currency.lower(),
        metadata={
            'plan_id': plan_id,
            'user_id': str(request.user.id)
        }
    )
    
    return Response({'clientSecret': intent.client_secret})
```

**Why It Matters:**
- Secure payment processing
- PCI compliance (Stripe handles cards)
- Transaction tracking
- Revenue collection

---

##### **ConfirmPayment** - `/api/confirm-payment/`
**Importance:** Critical - Payment completion

**Purpose:** Confirms successful payment and creates records

**Flow:**
1. Receives payment_intent_id from Stripe
2. Verifies payment succeeded
3. Creates Payment record
4. Creates/updates Subscription
5. Returns success/error

```python
def post(self, request):
    payment_intent_id = request.data.get('payment_intent_id')
    
    # Verify with Stripe
    stripe.api_key = settings.STRIPE_SECRET_KEY
    intent = stripe.PaymentIntent.retrieve(payment_intent_id)
    
    if intent.status == 'succeeded':
        # Create payment record
        payment = Payment.objects.create(
            user=request.user,
            plan_id=intent.metadata['plan_id'],
            amount=intent.amount / 100,
            currency=intent.currency.upper(),
            status='paid',
            transaction_id=payment_intent_id
        )
        
        # Activate subscription
        Subscription.objects.create(
            user=request.user,
            plan_id=intent.metadata['plan_id'],
            status='active'
        )
        
        return Response({'success': True})
```

**Why It Matters:**
- Financial record keeping
- Subscription activation
- Audit trail for payments
- Customer support reference

---

##### **UserPurchases** - `/api/users/<user_id>/payments/`
**Importance:** Medium - Purchase history

**Purpose:** Retrieves user's payment history

```python
def get(self, request, user_id):
    payments = Payment.objects.filter(user_id=user_id).order_by('-payment_date')
    
    return Response([{
        'id': payment.id,
        'amount': payment.amount,
        'plan_name': payment.plan.name,
        'payment_date': payment.payment_date,
        'status': payment.status,
        'transaction_id': payment.transaction_id
    } for payment in payments])
```

**Why It Matters:**
- Customer support
- Refund processing
- Invoice generation
- Financial reporting

---

#### 5. **Analytics & Reporting** (â­ Important)

##### **RevenueAnalyticsView** - `/api/analytics/revenue/`
**Importance:** High - Business metrics

**Purpose:** Provides revenue statistics for admin dashboard

**Metrics Calculated:**
- Total revenue (all time)
- Monthly revenue
- Average revenue per user (ARPU)
- Total active subscriptions
- Revenue by plan
- Growth trends

```python
def get(self, request):
    # Total revenue
    total_revenue = Payment.objects.filter(
        status='paid'
    ).aggregate(total=Sum('amount'))['total'] or 0
    
    # Monthly revenue (current month)
    this_month_start = timezone.now().replace(day=1, hour=0, minute=0)
    monthly_revenue = Payment.objects.filter(
        status='paid',
        payment_date__gte=this_month_start
    ).aggregate(total=Sum('amount'))['total'] or 0
    
    # Average revenue per user
    paying_users = Payment.objects.values('user').distinct().count()
    arpu = total_revenue / paying_users if paying_users > 0 else 0
    
    # Revenue by plan
    plan_revenue = Payment.objects.filter(
        status='paid'
    ).values('plan__name').annotate(
        revenue=Sum('amount')
    ).order_by('-revenue')
    
    return Response({
        'total_revenue': total_revenue,
        'monthly_revenue': monthly_revenue,
        'arpu': arpu,
        'plan_breakdown': plan_revenue
    })
```

**Why It Matters:**
- Business decision making
- Growth tracking
- Plan performance analysis
- Financial forecasting

---

##### **PlanAnalyticsView** - `/api/analytics/plans/`
**Importance:** High - Plan performance

**Purpose:** Analyzes plan popularity and conversion

**Metrics:**
- Subscriptions per plan
- Active vs. canceled breakdown
- Conversion rates
- User distribution

```python
def get(self, request):
    plans = Plan.objects.all()
    analytics = []
    
    for plan in plans:
        total_subs = Subscription.objects.filter(plan=plan).count()
        active_subs = Subscription.objects.filter(
            plan=plan, 
            status='active'
        ).count()
        
        analytics.append({
            'plan_name': plan.name,
            'plan_price': plan.price,
            'total_subscriptions': total_subs,
            'active_subscriptions': active_subs,
            'canceled_subscriptions': total_subs - active_subs,
            'conversion_rate': (active_subs / total_subs * 100) if total_subs > 0 else 0
        })
    
    return Response(analytics)
```

**Why It Matters:**
- Identifies popular plans
- Reveals pricing issues
- Guides marketing efforts
- Optimizes product offerings

---

##### **HostingCostsView** - `/api/hosting-costs/`
**Importance:** Medium - Cost management

**Purpose:** Tracks infrastructure expenses

**Operations:**

**GET** - List all costs
```python
def get(self, request):
    costs = Cost.objects.all().order_by('-date')
    
    # Calculate totals by category
    total_by_category = Cost.objects.values('category').annotate(
        total=Sum('amount')
    )
    
    return Response({
        'costs': costs,
        'totals': total_by_category,
        'grand_total': Cost.objects.aggregate(Sum('amount'))['amount__sum']
    })
```

**POST** - Add new cost (Admin only)
```python
def post(self, request):
    cost = Cost.objects.create(
        description=request.data['description'],
        amount=request.data['amount'],
        category=request.data.get('category', 'general'),
        plan_id=request.data.get('plan_id')  # Optional: plan-specific cost
    )
```

**DELETE** - Remove cost
```python
def delete(self, request, cost_id):
    Cost.objects.filter(id=cost_id).delete()
```

**Categories:**
- `hosting` - Server costs (DigitalOcean, AWS, etc.)
- `database` - Supabase subscription
- `cdn` - Content delivery network
- `docker` - Container registry
- `stripe` - Payment processing fees
- `general` - Miscellaneous

**Why It Matters:**
- Profit margin calculation
- Cost optimization
- Budget planning
- ROI analysis

---

#### 6. **User Activity Tracking** (â­ Important)

##### **UserActivityAnalyticsView** - `/api/analytics/user-activity/`
**Importance:** High - User engagement metrics

**Purpose:** Comprehensive user activity analytics for admin dashboard

**Metrics Provided:**

1. **Overview Statistics:**
   - Total active users
   - Currently online users (last 15 min)
   - Today's active users
   - Week's active users
   - Average session duration
   - Total time spent (hours)

2. **Daily Activity Trend:**
   - User count per day (full date range from database)
   - Total time spent per day
   - Active users per day

3. **Top Active Users:**
   - Top 10 users by time spent
   - Session counts per user
   - Formatted time display (hours + minutes)

4. **Hourly Distribution:**
   - User activity by hour of day (0-23)
   - Aggregated across all dates

```python
def get(self, request):
    now = timezone.now()
    today_start = now.replace(hour=0, minute=0, second=0, microsecond=0)
    
    # Get all sessions
    sessions = UserSession.objects.all()
    
    # Currently online users (active sessions in last 15 min)
    fifteen_minutes_ago = now - timedelta(minutes=15)
    active_sessions = UserSession.objects.filter(
        logout_time__isnull=True,
        login_time__gte=fifteen_minutes_ago
    ).select_related('user')
    
    online_users = []
    for session in active_sessions:
        online_users.append({
            'email': session.user.email,
            'id': str(session.user.id),
            'last_active': session.login_time.isoformat()
        })
    
    # Daily activity (dynamic date range from database)
    from django.db.models import Min, Max
    date_range = sessions.aggregate(
        earliest=Min('login_time'),
        latest=Max('login_time')
    )
    
    daily_activity = []
    # ... Calculate daily metrics for each day in range ...
    
    # Top users
    top_users = sessions.values('user__email').annotate(
        total_time=Sum('duration_minutes'),
        session_count=Count('id')
    ).order_by('-total_time')[:10]
    
    # Hourly distribution
    hourly_activity = []
    for hour in range(24):
        hour_count = sessions.filter(
            login_time__hour=hour
        ).values('user').distinct().count()
        
        hourly_activity.append({
            'hour': f"{hour:02d}:00",
            'users': hour_count
        })
    
    return Response({
        'overview': {...},
        'online_users': online_users,
        'daily_activity': daily_activity,
        'top_users': top_users,
        'hourly_activity': hourly_activity
    })
```

**Why It Matters:**
- User engagement insights
- Peak usage times
- Feature usage patterns
- Retention analysis
- Capacity planning

---

##### **UserSessionTrackingView** - `/api/session-tracking/`
**Importance:** High - Session lifecycle management

**Purpose:** Creates and closes user sessions

**Operations:**

**POST with action='login':**
```python
def post(self, request):
    action = request.data.get('action')  # 'login' or 'logout'
    user_email = request.data.get('email')
    
    if action == 'login':
        # Create new session
        session = UserSession.objects.create(
            user=user,
            login_time=timezone.now(),
            ip_address=self.get_client_ip(request)
        )
        
        return Response({
            'success': True,
            'session_id': session.id
        })
```

**POST with action='logout':**
```python
    elif action == 'logout':
        # Find active session
        session = UserSession.objects.filter(
            user=user,
            logout_time__isnull=True
        ).order_by('-login_time').first()
        
        if session:
            session.logout_time = timezone.now()
            session.calculate_duration()  # Sets duration_minutes
            
            return Response({
                'success': True,
                'duration_minutes': session.duration_minutes
            })
```

**Integration with Frontend:**

```javascript
// useAuth.js - On login
const signIn = async (email, password) => {
    // ... Supabase auth ...
    
    // Track session
    const sessionData = await trackSession('login', email);
    sessionStorage.setItem('djangoSessionId', sessionData.session_id);
}

// useAuth.js - On logout
const signOut = async () => {
    const sessionId = sessionStorage.getItem('djangoSessionId');
    await trackSession('logout', email, sessionId);
    
    // Clear session storage
    sessionStorage.removeItem('djangoSessionId');
}
```

**Why It Matters:**
- Accurate time tracking
- Concurrent user monitoring
- Session management
- User behavior analysis
- Security auditing

---

##### **UserActivityChartView** - `/charts/user-activity/`
**Importance:** Medium - Visual analytics

**Purpose:** Generates PNG chart image of user activity over time

**Technology:** Matplotlib library

**Chart Features:**
- Line chart with gradient fill
- Shows hours spent online per day
- Dark theme matching admin dashboard
- Dynamic date range (from database)
- Green color scheme (#22c55e)

```python
def get(self, request):
    import matplotlib.pyplot as plt
    from io import BytesIO
    
    # Get session data
    sessions = UserSession.objects.all()
    
    # Calculate daily hours
    daily_data = []
    labels = []
    
    for i in range(days_diff):
        day_minutes = UserSession.objects.filter(
            login_time__gte=day_start,
            login_time__lt=day_end
        ).aggregate(total=Sum('duration_minutes'))['total'] or 0
        
        hours = day_minutes / 60
        daily_data.append(hours)
        labels.append(day_start.strftime('%m/%d'))
    
    # Create chart
    fig, ax = plt.subplots(figsize=(12, 6))
    fig.patch.set_facecolor("#1e242c")
    ax.set_facecolor("#2b3139")
    
    # Plot with gradient
    ax.fill_between(range(len(daily_data)), daily_data, 
                     alpha=0.3, color="#22c55e")
    ax.plot(labels, daily_data, marker="o", 
            color="#22c55e", label="Hours Online")
    
    # Export to PNG
    buf = BytesIO()
    plt.savefig(buf, format="png", bbox_inches="tight")
    buf.seek(0)
    
    return HttpResponse(buf.getvalue(), content_type="image/png")
```

**Why It Matters:**
- Visual data representation
- Trend identification
- Executive dashboards
- Presentation-ready graphics

---

#### 7. **Chart Generation** (Medium Importance)

##### **Plans Pie Chart** - `/piechart.png`
**Purpose:** Visual distribution of users by plan

```python
def get(self, request):
    # Count users per plan
    subscriptions = Subscription.objects.filter(status='active')
    plan_counts = subscriptions.values('plan__name').annotate(
        count=Count('id')
    )
    
    # Generate pie chart with Matplotlib
    # ... matplotlib code ...
    
    return HttpResponse(image_data, content_type="image/png")
```

---

##### **Monthly Costs Line Chart** - `/charts/monthly-costs/`
**Purpose:** Visualizes hosting costs over time

```python
def get(self, request):
    # Get costs by month
    monthly_costs = Cost.objects.annotate(
        month=TruncMonth('date')
    ).values('month').annotate(
        total=Sum('amount')
    ).order_by('month')
    
    # Generate line chart
    # ... matplotlib code ...
    
    return HttpResponse(image_data, content_type="image/png")
```

---

#### 8. **PDF Report Generation** (Medium Importance)

##### **GeneratePDFReportView** - `/api/generate-pdf-report/`
**Importance:** Medium - Business reporting

**Purpose:** Creates comprehensive PDF business analytics report

**Report Sections:**
1. Executive Summary
   - Total revenue
   - Active subscriptions
   - Monthly recurring revenue (MRR)
   - Growth rate

2. Revenue Analytics
   - Revenue by plan (table)
   - Payment status breakdown
   - Top paying customers

3. Plan Profitability
   - Revenue per plan
   - Cost per plan
   - Profit margins

4. Infrastructure Costs
   - Cost breakdown by category
   - Total costs
   - Cost trends

**Technology:** ReportLab library

```python
def get(self, request):
    from reportlab.lib.pagesizes import letter
    from reportlab.platypus import SimpleDocTemplate, Table, Paragraph
    from reportlab.lib.styles import getSampleStyleSheet
    
    buffer = BytesIO()
    doc = SimpleDocTemplate(buffer, pagesize=letter)
    
    # Build report elements
    elements = []
    
    # Title
    styles = getSampleStyleSheet()
    title = Paragraph("PlayAtac Business Analytics Report", 
                      styles['Title'])
    elements.append(title)
    
    # Revenue table
    revenue_data = [
        ['Plan', 'Revenue', 'Users'],
        # ... data rows ...
    ]
    table = Table(revenue_data)
    elements.append(table)
    
    # Build PDF
    doc.build(elements)
    
    # Return as download
    buffer.seek(0)
    response = HttpResponse(buffer.getvalue(), 
                          content_type='application/pdf')
    response['Content-Disposition'] = 'attachment; filename="report.pdf"'
    return response
```

**Why It Matters:**
- Stakeholder reporting
- Investor presentations
- Executive summaries
- Offline analysis

---

## Database Models

### Model Relationships Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     User       â”‚
â”‚  (UUID PK)     â”‚
â”‚  - email       â”‚
â”‚  - username    â”‚
â”‚  - role        â”‚
â”‚  - is_staff    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”‚ 1:N (One user has many subscriptions)
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Subscription   â”‚ N:1     â”‚     Plan       â”‚
â”‚  - user_id (FK)â”œâ”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  - name        â”‚
â”‚  - plan_id (FK)â”‚         â”‚  - price       â”‚
â”‚  - status      â”‚         â”‚  - currency    â”‚
â”‚  - start_date  â”‚         â”‚  - features    â”‚
â”‚  - renewal_dateâ”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
        â”‚                           â”‚ 1:N (Plans have costs)
        â”‚ 1:N                       â”‚
        â”‚                           â–¼
        â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                  â”‚     Cost       â”‚
        â”‚                  â”‚  - plan_id(FK) â”‚
        â”‚                  â”‚  - amount      â”‚
        â”‚                  â”‚  - category    â”‚
        â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”‚ User also has payments
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Payment     â”‚ N:1     â”‚  UserSession   â”‚
â”‚  - user_id (FK)â”‚         â”‚  - user_id(FK) â”‚
â”‚  - plan_id (FK)â”‚         â”‚  - login_time  â”‚
â”‚  - amount      â”‚         â”‚  - logout_time â”‚
â”‚  - status      â”‚         â”‚  - duration    â”‚
â”‚  - trans_id    â”‚         â”‚  - ip_address  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Model Details

#### User Model
```python
class User(AbstractBaseUser, PermissionsMixin):
    id = models.UUIDField(primary_key=True, default=uuid.uuid4)  # Matches Supabase
    email = models.EmailField(unique=True)
    username = models.CharField(max_length=150, unique=True, null=True)
    role = models.CharField(choices=[('user', 'User'), ('admin', 'Admin')])
    is_staff = models.BooleanField(default=False)
    is_active = models.BooleanField(default=True)
    date_joined = models.DateTimeField(default=timezone.now)
```

**Key Features:**
- Uses UUID to match Supabase auth user IDs
- Email is the primary identifier (USERNAME_FIELD)
- Role-based access (user vs admin)
- Compatible with Django admin panel

---

#### Plan Model
```python
class Plan(models.Model):
    name = models.CharField(max_length=50, unique=True)
    price = models.DecimalField(max_digits=10, decimal_places=2)
    currency = models.CharField(max_length=5, default="EUR")
    features = models.TextField(blank=True)
    created_at = models.DateTimeField(auto_now_add=True)
```

**Example Data:**
- Free: â‚¬0.00, "5 games, Basic support"
- Pro: â‚¬9.99, "50 games, Priority support, Cloud saves"
- Premium: â‚¬19.99, "Unlimited games, 24/7 support, Early access"

---

#### Subscription Model
```python
class Subscription(models.Model):
    user = models.ForeignKey(User, on_delete=models.CASCADE)
    plan = models.ForeignKey(Plan, on_delete=models.CASCADE)
    status = models.CharField(choices=[
        ('active', 'Active'),
        ('canceled', 'Canceled'),
        ('trial', 'Trial')
    ])
    start_date = models.DateTimeField(auto_now_add=True)
    renewal_date = models.DateTimeField(null=True, blank=True)
    end_date = models.DateTimeField(null=True, blank=True)
```

**Business Rules:**
- One active subscription per user
- Renewal_date is 30 days from start
- End_date set on cancellation
- Status determines access

---

#### Payment Model
```python
class Payment(models.Model):
    user = models.ForeignKey(User, on_delete=models.CASCADE)
    plan = models.ForeignKey(Plan, on_delete=models.CASCADE)
    amount = models.DecimalField(max_digits=10, decimal_places=2)
    currency = models.CharField(max_length=5, default="EUR")
    payment_date = models.DateTimeField(auto_now_add=True)
    status = models.CharField(choices=[
        ('paid', 'Paid'),
        ('pending', 'Pending'),
        ('failed', 'Failed')
    ])
    transaction_id = models.CharField(max_length=100)  # Stripe payment ID
```

**Purpose:**
- Financial record of all transactions
- Links to Stripe payment intents
- Used for revenue analytics
- Audit trail for refunds

---

#### Cost Model
```python
class Cost(models.Model):
    description = models.CharField(max_length=255)
    amount = models.DecimalField(max_digits=10, decimal_places=2)
    currency = models.CharField(max_length=5, default="EUR")
    date = models.DateTimeField(auto_now_add=True)
    category = models.CharField(max_length=50)  # hosting, database, cdn, etc.
    plan = models.ForeignKey(Plan, on_delete=models.CASCADE, null=True)  # Optional
```

**Purpose:**
- Track infrastructure expenses
- Calculate profit margins
- Plan-specific cost allocation
- Budget management

---

#### UserSession Model
```python
class UserSession(models.Model):
    user = models.ForeignKey(User, on_delete=models.CASCADE)
    login_time = models.DateTimeField()
    logout_time = models.DateTimeField(null=True, blank=True)
    duration_minutes = models.IntegerField(default=0)
    ip_address = models.GenericIPAddressField(null=True)
    
    def calculate_duration(self):
        if self.logout_time:
            delta = self.logout_time - self.login_time
            self.duration_minutes = int(delta.total_seconds() / 60)
            self.save()
```

**Purpose:**
- Track user engagement
- Monitor concurrent users
- Analytics on usage patterns
- Security auditing

---

## API Endpoints Reference

### Public Endpoints (No Authentication Required)

| Method | Endpoint | Purpose |
|--------|----------|---------|
| GET | `/api/plans/` | List all subscription plans |
| GET | `/api/stripe-config/` | Get Stripe public key |
| GET | `/piechart.png` | Plan distribution chart |
| GET | `/charts/monthly-costs/` | Cost trends chart |
| GET | `/charts/user-activity/` | Activity chart image |

### User Endpoints (Authentication Required)

| Method | Endpoint | Purpose |
|--------|----------|---------|
| GET | `/api/user-subscription/` | Get user's subscription |
| POST | `/api/create-payment-intent/` | Initiate payment |
| POST | `/api/confirm-payment/` | Complete payment |
| GET | `/api/users/<id>/payments/` | User payment history |
| POST | `/api/session-tracking/` | Track login/logout |

### Admin Endpoints (Admin Role Required)

| Method | Endpoint | Purpose |
|--------|----------|---------|
| GET | `/api/users/` | List all users |
| PATCH | `/api/users/` | Update user role |
| DELETE | `/api/users/` | Delete user |
| POST | `/api/plans/` | Create plan |
| PUT | `/api/plans/` | Update plan |
| DELETE | `/api/plans/` | Delete plan |
| GET | `/api/analytics/revenue/` | Revenue stats |
| GET | `/api/analytics/plans/` | Plan analytics |
| GET | `/api/analytics/user-activity/` | User activity stats |
| GET | `/api/hosting-costs/` | List costs |
| POST | `/api/hosting-costs/` | Add cost |
| DELETE | `/api/hosting-costs/<id>/` | Delete cost |
| GET | `/api/generate-pdf-report/` | Generate PDF |

---

## Authentication & Authorization

### Authentication Levels

1. **Public Access** (`AllowAny`)
   - Plan listings
   - Charts (read-only)
   - Stripe config

2. **Authenticated User** (`IsAuthenticated`)
   - View own subscription
   - Make payments
   - View own payment history
   - Track sessions

3. **Admin User** (`IsAuthenticated + role='admin'`)
   - User management
   - Plan management
   - Analytics access
   - Cost management
   - Report generation

### Permission Checking

```python
# In views.py
def get(self, request):
    if request.user.role != 'admin':
        return Response(
            {'error': 'Admin access required'},
            status=status.HTTP_403_FORBIDDEN
        )
    
    # Admin logic here...
```

---

## Session Management

### Frontend Session Flow

1. **Login:**
   - User enters credentials
   - `supabase.auth.signInWithPassword()`
   - Receives JWT token
   - Stores in memory (not localStorage for security)
   - Calls Django `/api/session-tracking/` with action='login'
   - Stores session_id in sessionStorage

2. **Active Session:**
   - JWT token included in every API request
   - Django validates token with Supabase
   - Session updated on activity
   - Frontend tracks last activity time

3. **Logout:**
   - User clicks logout
   - Calls Django `/api/session-tracking/` with action='logout'
   - Session duration calculated
   - `supabase.auth.signOut()`
   - Clears sessionStorage
   - Redirects to login

4. **Session Timeout:**
   - Sessions inactive >15 min considered offline
   - JWT tokens expire after Supabase timeout
   - Frontend refreshes token automatically
   - Backend checks session validity

### Session Security

- JWT tokens not stored in localStorage (XSS protection)
- Session IDs are UUIDs (not sequential)
- IP addresses logged for audit
- Concurrent session detection
- Automatic cleanup of old sessions

---

## Payment Processing

### Stripe Integration Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Frontend  â”‚
â”‚  (React)   â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
      â”‚ 1. User selects plan
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST /api/create-payment-intent/   â”‚
â”‚  Body: { plan_id: 2 }              â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚ 2. Django creates PaymentIntent
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Stripe   â”‚ â† 3. Creates intent, returns client_secret
â”‚    API     â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
      â”‚ 4. Returns client_secret
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Frontend  â”‚ â† 5. Displays Stripe payment form
â”‚  (Stripe)  â”‚    User enters card details
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
      â”‚ 6. Submits to Stripe (not Django)
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Stripe   â”‚ â† 7. Processes payment
â”‚   Servers  â”‚    Returns success/failure
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
      â”‚ 8. Payment confirmed
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST /api/confirm-payment/         â”‚
â”‚  Body: { payment_intent_id: "pi_" }â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚ 9. Django verifies with Stripe
      â”‚ 10. Creates Payment record
      â”‚ 11. Activates Subscription
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Database  â”‚ â† 12. User now has active subscription
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Payment Security

- **PCI Compliance:** Card data never touches Django server
- **Stripe Elements:** Secure hosted form fields
- **Webhook Verification:** Stripe webhooks for async payment updates
- **Idempotency:** Prevent duplicate charges
- **Refund Support:** Track refund status

---

## Analytics & Reporting

### Data Collection Points

1. **User Registration** â†’ Date joined tracking
2. **Login/Logout** â†’ Session duration, active users
3. **Plan Selection** â†’ Conversion funnel
4. **Payment** â†’ Revenue tracking, plan popularity
5. **Subscription Changes** â†’ Upgrade/downgrade patterns
6. **Cost Entry** â†’ Expense tracking

### Analytics Dashboard Features

**Revenue Metrics:**
- Total revenue (lifetime)
- Monthly recurring revenue (MRR)
- Average revenue per user (ARPU)
- Revenue by plan
- Payment success rate

**User Metrics:**
- Total users
- Active subscriptions
- Churn rate
- User growth rate
- Engagement time

**Plan Performance:**
- Subscriptions per plan
- Conversion rates
- Popular features
- Upgrade paths

**Cost Analysis:**
- Total expenses
- Cost per user
- Profit margins
- Cost categories
- Efficiency metrics

---

## Setup & Configuration

### Prerequisites

- Docker & Docker Compose
- Node.js 16+ (for local frontend development)
- Python 3.11+ (for local backend development)
- Supabase account
- Stripe account (test mode)

### Environment Setup

1. **Clone Repository:**
```bash
git clone https://github.com/CasianJors/Python-Academy-Projects.git
cd Python-Academy-Projects
```

2. **Configure Supabase:**
   - Create project at supabase.com
   - Get database URL from Settings â†’ Database
   - Get API keys from Settings â†’ API
   - Enable Email authentication

3. **Configure Stripe:**
   - Create account at stripe.com
   - Get test API keys from Developers â†’ API keys
   - Use test mode for development

4. **Backend .env:**
```bash
cd backend
cat > .env << EOF
SUPABASE_DB_URL=postgresql://postgres:[PASSWORD]@db.[PROJECT].supabase.co:5432/postgres
SUPABASE_URL=https://[PROJECT].supabase.co
SUPABASE_KEY=[SERVICE_ROLE_KEY]
STRIPE_SECRET_KEY=sk_test_...
STRIPE_PUBLISHABLE_KEY=pk_test_...
EOF
```

5. **Frontend .env:**
```bash
cd frontend/exemplu
cat > .env << EOF
REACT_APP_SUPABASE_URL=https://[PROJECT].supabase.co
REACT_APP_SUPABASE_ANON_KEY=[ANON_KEY]
REACT_APP_DJANGO_URL=http://localhost:8000
REACT_APP_STRIPE_PUBLISHABLE_KEY=pk_test_...
EOF
```

6. **Database Migrations:**
```bash
docker-compose up -d backend
docker exec python-academy-projects-backend-1 python manage.py migrate
```

7. **Create Superuser:**
```bash
docker exec -it python-academy-projects-backend-1 python manage.py createsuperuser
```

8. **Start Application:**
```bash
docker-compose up
```

### Accessing the Application

- **Frontend:** http://localhost:3000
- **Backend API:** http://localhost:8000
- **Django Admin:** http://localhost:8000/admin

---

## Docker Architecture

### Container Structure

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Docker Network                        â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Frontend Container  â”‚    â”‚  Backend Container   â”‚  â”‚
â”‚  â”‚  - React App         â”‚    â”‚  - Django App        â”‚  â”‚
â”‚  â”‚  - Node.js           â”‚    â”‚  - Python 3.11       â”‚  â”‚
â”‚  â”‚  - Port 3000         â”‚    â”‚  - Port 8000         â”‚  â”‚
â”‚  â”‚  - Dev Server        â”‚    â”‚  - Gunicorn (prod)   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚             â”‚                           â”‚              â”‚
â”‚             â”‚  HTTP Requests            â”‚              â”‚
â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                           â”‚
              â”‚                           â”‚
              â–¼                           â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Browser  â”‚              â”‚   Supabase   â”‚
        â”‚  Client  â”‚              â”‚  PostgreSQL  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### docker-compose.yml

```yaml
version: '3.8'

services:
  backend:
    build: ./backend
    ports:
      - "8000:8000"
    environment:
      - SUPABASE_DB_URL=${SUPABASE_DB_URL}
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_KEY=${SUPABASE_KEY}
    volumes:
      - ./backend:/app
    command: python manage.py runserver 0.0.0.0:8000

  frontend:
    build: ./frontend/exemplu
    ports:
      - "3000:3000"
    environment:
      - REACT_APP_DJANGO_URL=http://localhost:8000
      - REACT_APP_SUPABASE_URL=${REACT_APP_SUPABASE_URL}
      - REACT_APP_SUPABASE_ANON_KEY=${REACT_APP_SUPABASE_ANON_KEY}
    volumes:
      - ./frontend/exemplu:/app
    command: npm start
```

### Dockerfile (Backend)

```dockerfile
FROM python:3.11-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

CMD ["python", "manage.py", "runserver", "0.0.0.0:8000"]
```

### Dockerfile (Frontend)

```dockerfile
FROM node:18-alpine

WORKDIR /app

COPY package*.json ./
RUN npm install

COPY . .

EXPOSE 3000

CMD ["npm", "start"]
```

---

## Troubleshooting

### Common Issues

**Issue:** Frontend can't connect to backend
```bash
# Check backend is running
docker ps

# Check logs
docker logs python-academy-projects-backend-1

# Verify CORS settings in Django settings.py
CORS_ALLOW_ALL_ORIGINS = True
```

**Issue:** Authentication fails
```bash
# Verify Supabase credentials
# Check .env files
# Test Supabase connection
docker exec python-academy-projects-backend-1 python manage.py shell
>>> from supabase import create_client
>>> supabase = create_client(SUPABASE_URL, SUPABASE_KEY)
>>> print(supabase)
```

**Issue:** Payments not working
```bash
# Verify Stripe test keys
# Check webhook setup
# Test in Stripe dashboard
# Review payment logs in Django admin
```

**Issue:** Charts not loading
```bash
# Check matplotlib installation
pip install matplotlib

# Verify image generation
# Check CORS headers on chart endpoints
```

---

## Contributing

### Development Workflow

1. Create feature branch
2. Make changes
3. Test locally with Docker
4. Run migrations if models changed
5. Update documentation
6. Submit pull request

### Code Standards

- **Python:** PEP 8 style guide
- **JavaScript:** ESLint + Prettier
- **Git:** Conventional commits
- **Documentation:** Docstrings for all functions

---

## License

MIT License - See LICENSE file for details

---

## Support

For issues or questions:
- GitHub Issues: [Repository Issues](https://github.com/CasianJors/Python-Academy-Projects/issues)
- Team: Project-2-Team-2

---

**Last Updated:** October 2, 2025  
**Version:** 1.0.0  
**Branch:** Project-2-Team-2
